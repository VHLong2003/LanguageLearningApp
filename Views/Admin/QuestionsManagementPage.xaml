<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LanguageLearningApp.Views.Admin.QuestionsManagementPage"
             x:Name="ThisPage"
             Title="Quản lý câu hỏi">

    <ScrollView>
        <RefreshView IsRefreshing="{Binding IsRefreshing}" Command="{Binding RefreshCommand}">
            <StackLayout Spacing="16" Padding="16">
                <Label Text="QUẢN LÝ CÂU HỎI" FontSize="22" FontAttributes="Bold" HorizontalOptions="Center"/>
                <Label Text="{Binding CurrentLesson.Title}" FontSize="18" FontAttributes="Bold" TextColor="#0284C7" HorizontalOptions="Center"/>
                <Button Text="+ Tạo câu hỏi mới" Command="{Binding CreateQuestionCommand}" BackgroundColor="#2563EB" TextColor="White" CornerRadius="8" />
                <CollectionView ItemsSource="{Binding Questions}" SelectedItem="{Binding SelectedQuestion, Mode=TwoWay}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Margin="0,8" Padding="10" CornerRadius="14" HasShadow="True" BackgroundColor="#F0F9FF">
                                <StackLayout Orientation="Horizontal" Spacing="10" VerticalOptions="Center">
                                    <Image Source="{Binding ImageUrl}" HeightRequest="48" WidthRequest="48" Aspect="AspectFill" />
                                    <StackLayout VerticalOptions="Center" Spacing="4" WidthRequest="160">
                                        <Label Text="{Binding Content}" FontAttributes="Bold" FontSize="15" />
                                        <Label Text="{Binding Type}" FontSize="12" TextColor="#0284C7" />
                                    </StackLayout>
                                    <StackLayout HorizontalOptions="EndAndExpand" Orientation="Horizontal" Spacing="6">
                                        <Button Text="▲" Command="{Binding BindingContext.MoveUpCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" FontSize="13" />
                                        <Button Text="▼" Command="{Binding BindingContext.MoveDownCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" FontSize="13" />
                                        <Button Text="Xóa" Command="{Binding BindingContext.DeleteQuestionCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" FontSize="13" TextColor="Red" />
                                    </StackLayout>
                                </StackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <!-- Biểu mẫu chỉnh sửa/tạo câu hỏi -->
                <Frame Padding="16" CornerRadius="16" BackgroundColor="#CFFAFE" IsVisible="{Binding IsEditing}">
                    <ScrollView>
                        <StackLayout Spacing="10">
                            <Entry Placeholder="Nội dung câu hỏi" Text="{Binding Content}"/>
                            <Picker Title="Loại câu hỏi" ItemsSource="{Binding QuestionTypes}" SelectedItem="{Binding Type}"/>
                            <Entry Placeholder="Điểm số" Text="{Binding Points}" Keyboard="Numeric"/>
                            <Entry Placeholder="Thứ tự" Text="{Binding Order}" Keyboard="Numeric"/>
                            <Entry Placeholder="Thời gian giới hạn (giây)" Text="{Binding TimeLimit}" Keyboard="Numeric"/>
                            <Entry Placeholder="Giải thích (tuỳ chọn)" Text="{Binding Explanation}"/>
                            <Image Source="{Binding ImageUrl}" HeightRequest="64" Aspect="AspectFill"/>
                            <Button Text="Chọn ảnh cho câu hỏi" Command="{Binding PickImageCommand}"/>
                            <Entry Placeholder="Audio URL (nếu có)" Text="{Binding AudioUrl}"/>
                            <Entry Placeholder="Đáp án đúng" Text="{Binding CorrectAnswer}"/>
                            <!-- MultipleChoice Options -->
                            <StackLayout IsVisible="{Binding Type, Converter={StaticResource QuestionTypeIsMultipleChoiceConverter}}">
                                <Label Text="Tuỳ chọn câu trả lời:"/>
                                <CollectionView ItemsSource="{Binding Options}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <StackLayout Orientation="Horizontal" Spacing="6">
                                                <Label Text="{Binding .}"/>
                                                <Button Text="X" Command="{Binding BindingContext.RemoveOptionCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" TextColor="Red"/>
                                            </StackLayout>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Entry Placeholder="Tuỳ chọn mới" Text="{Binding NewOption}" WidthRequest="150"/>
                                    <Button Text="Thêm" Command="{Binding AddOptionCommand}"/>
                                </StackLayout>
                            </StackLayout>
                            <StackLayout Orientation="Horizontal" HorizontalOptions="EndAndExpand" Spacing="10">
                                <Button Text="Lưu" Command="{Binding SaveQuestionCommand}" BackgroundColor="#22C55E" TextColor="White" />
                                <Button Text="Hủy" Command="{Binding CancelEditCommand}" BackgroundColor="#EF4444" TextColor="White" />
                            </StackLayout>
                        </StackLayout>
                    </ScrollView>
                </Frame>
                <Label Text="{Binding ErrorMessage}" TextColor="Red" FontAttributes="Italic" IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotNullOrEmptyConverter}}"/>
                <Button Text="← Quay lại bài học" Command="{Binding BackToLessonsCommand}" HorizontalOptions="Start"/>
            </StackLayout>
        </RefreshView>
    </ScrollView>
</ContentPage>
