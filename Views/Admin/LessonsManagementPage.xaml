<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LanguageLearningApp.Views.Admin.LessonsManagementPage"
             x:Name="ThisPage"
             Title="Quản lý bài học">

    <RefreshView IsRefreshing="{Binding IsRefreshing}" Command="{Binding RefreshCommand}">
        <StackLayout Spacing="16" Padding="16">
            <Label Text="QUẢN LÝ BÀI HỌC" FontSize="22" FontAttributes="Bold" HorizontalOptions="Center"/>
            <Label Text="{Binding CurrentCourse.Title}" FontSize="18" FontAttributes="Bold" TextColor="#6366F1" HorizontalOptions="Center"/>
            <Button Text="+ Tạo bài học mới" Command="{Binding CreateLessonCommand}" BackgroundColor="#6366F1" TextColor="White" CornerRadius="8" />
            <CollectionView ItemsSource="{Binding Lessons}" SelectedItem="{Binding SelectedLesson, Mode=TwoWay}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="0,8" Padding="10" CornerRadius="14" HasShadow="True" BackgroundColor="#F1F5F9">
                            <StackLayout Orientation="Horizontal" Spacing="10" VerticalOptions="Center">
                                <Image Source="{Binding ImageUrl}" HeightRequest="56" WidthRequest="56" Aspect="AspectFill" />
                                <StackLayout VerticalOptions="Center" Spacing="4" WidthRequest="160">
                                    <Label Text="{Binding Title}" FontAttributes="Bold" FontSize="16" />
                                    <Label Text="{Binding Description}" FontSize="13" TextColor="#64748B" LineBreakMode="TailTruncation" MaxLines="2" />
                                </StackLayout>
                                <StackLayout HorizontalOptions="EndAndExpand" Orientation="Horizontal" Spacing="6">
                                    <Button Text="Câu hỏi" Command="{Binding BindingContext.ManageQuestionsCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" FontSize="13" />
                                    <Button Text="▲" Command="{Binding BindingContext.MoveUpCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" FontSize="13" />
                                    <Button Text="▼" Command="{Binding BindingContext.MoveDownCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" FontSize="13" />
                                    <Button Text="Xóa" Command="{Binding BindingContext.DeleteLessonCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" FontSize="13" TextColor="Red" />
                                </StackLayout>
                            </StackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <!-- Biểu mẫu chỉnh sửa/tạo bài học -->
            <Frame Padding="16" CornerRadius="16" BackgroundColor="#DBEAFE" IsVisible="{Binding IsEditing}">
                <StackLayout Spacing="10">
                    <Entry Placeholder="Tiêu đề bài học" Text="{Binding Title}"/>
                    <Editor Placeholder="Mô tả bài học" Text="{Binding Description}" AutoSize="TextChanges" HeightRequest="50"/>
                    <Editor Placeholder="Nội dung bài học" Text="{Binding Content}" AutoSize="TextChanges" HeightRequest="80"/>
                    <Entry Placeholder="Thứ tự" Text="{Binding Order}" Keyboard="Numeric"/>
                    <Entry Placeholder="Điểm yêu cầu để mở khóa" Text="{Binding RequiredPoints}" Keyboard="Numeric"/>
                    <Entry Placeholder="Điểm tối đa" Text="{Binding MaxPoints}" Keyboard="Numeric"/>
                    <Entry Placeholder="Thời gian ước tính (phút)" Text="{Binding EstimatedMinutes}" Keyboard="Numeric"/>
                    <Image Source="{Binding ImageUrl}" HeightRequest="80" Aspect="AspectFill"/>
                    <Button Text="Chọn hình ảnh" Command="{Binding PickImageCommand}"/>
                    <Entry Placeholder="Video URL (YouTube/Vimeo)" Text="{Binding VideoUrl}"/>
                    <StackLayout Orientation="Horizontal" HorizontalOptions="EndAndExpand" Spacing="10">
                        <Button Text="Lưu" Command="{Binding SaveLessonCommand}" BackgroundColor="#22C55E" TextColor="White" />
                        <Button Text="Hủy" Command="{Binding CancelEditCommand}" BackgroundColor="#EF4444" TextColor="White" />
                    </StackLayout>
                </StackLayout>
            </Frame>
            <Label Text="{Binding ErrorMessage}" TextColor="Red" FontAttributes="Italic" IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotNullOrEmptyConverter}}"/>
            <Button Text="← Quay lại khóa học" Command="{Binding BackToCoursesCommand}" HorizontalOptions="Start"/>
        </StackLayout>
    </RefreshView>
</ContentPage>
