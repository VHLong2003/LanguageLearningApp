<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="LanguageLearningApp.Views.User.CoursesPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:LanguageLearningApp.ViewModels.User"
    Title="Khoá học">

    <ContentPage.Resources>
        <!-- Style for featured course card -->
        <Style x:Key="FeaturedCardStyle" TargetType="Frame">
            <Setter Property="CornerRadius" Value="20"/>
            <Setter Property="HasShadow" Value="True"/>
            <Setter Property="BackgroundColor" Value="#EEF4FB"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="HeightRequest" Value="140"/>
            <Setter Property="WidthRequest" Value="260"/>
            <Setter Property="Margin" Value="8,0,8,0"/>
        </Style>
    </ContentPage.Resources>

    <RefreshView IsRefreshing="{Binding IsRefreshing}" Command="{Binding RefreshCommand}">
        <ScrollView>
            <VerticalStackLayout Spacing="18" Padding="0,16,0,24">
                <!-- Header & Search -->
                <VerticalStackLayout Spacing="8" Padding="16,0">
                    <Label Text="Khoá học" FontSize="32" FontAttributes="Bold" TextColor="#21264C" />
                    <SearchBar
                        Placeholder="Tìm kiếm khoá học"
                        Text="{Binding SearchQuery}"
                        SearchCommand="{Binding SearchCoursesCommand}"
                        FontSize="16"
                        BackgroundColor="#F1F4F9"
                        CancelButtonColor="#6376E0"
                        />
                </VerticalStackLayout>

                <!-- Categories filter -->
                <ScrollView Orientation="Horizontal" Margin="0,0,0,4">
                    <HorizontalStackLayout Padding="16,0" Spacing="12">
                        <Button
                            Text="Tất cả"
                            Command="{Binding FilterCoursesByCategoryCommand}"
                            CommandParameter="{x:Null}"
                            BackgroundColor="{Binding SelectedCategory, Converter={StaticResource NullToColorConverter}, ConverterParameter=#6376E0|#E0E7FF}"
                            TextColor="#21264C"
                            CornerRadius="18"
                            Padding="20,5"
                            FontAttributes="Bold"
                            />
                        <!-- Danh sách động các Category -->
                        <CollectionView
                            ItemsSource="{Binding Categories}"
                            ItemsLayout="HorizontalList"
                            SelectionMode="Single"
                            SelectedItem="{Binding SelectedCategory, Mode=TwoWay}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Button
                                        Text="{Binding .}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CoursesViewModel}}, Path=FilterCoursesByCategoryCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="{Binding ., Converter={StaticResource CategoryToColorConverter}, ConverterParameter={Binding Source={RelativeSource AncestorType={x:Type vm:CoursesViewModel}}, Path=SelectedCategory}}"
                                        TextColor="#21264C"
                                        CornerRadius="18"
                                        Padding="20,5"
                                        FontAttributes="Bold"/>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </HorizontalStackLayout>
                </ScrollView>

                <!-- Featured Courses -->
                <StackLayout>
                    <Label Text="Nổi bật" FontSize="20" FontAttributes="Bold" Margin="16,4,0,0" IsVisible="{Binding FeaturedCourses.Count, Converter={StaticResource IntToBoolConverter}}"/>
                    <ScrollView Orientation="Horizontal" HeightRequest="160">
                        <HorizontalStackLayout Spacing="0">
                            <CollectionView
                                ItemsSource="{Binding FeaturedCourses}"
                                ItemsLayout="HorizontalList"
                                SelectionMode="Single"
                                HeightRequest="140">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Frame Style="{StaticResource FeaturedCardStyle}" Margin="0,8">
                                            <Grid>
                                                <Image Source="{Binding ImageUrl}" Aspect="AspectFill" HeightRequest="100" />
                                                <Label Text="{Binding Title}" FontSize="16" FontAttributes="Bold" TextColor="#3C4662" Margin="8,4,8,0"/>
                                                <Label Text="{Binding Description}" FontSize="12" LineBreakMode="TailTruncation" Margin="8,28,8,0" TextColor="#5C6B90"/>
                                            </Grid>
                                            <Frame.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CoursesViewModel}}, Path=CourseSelectedCommand}" CommandParameter="{Binding .}" />
                                            </Frame.GestureRecognizers>
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </HorizontalStackLayout>
                    </ScrollView>
                </StackLayout>

                <!-- Danh sách khoá học -->
                <VerticalStackLayout Padding="0">
                    <Label Text="Tất cả khoá học" FontSize="20" FontAttributes="Bold" Margin="16,4,0,0" />
                    <CollectionView
                        ItemsSource="{Binding Courses}"
                        SelectionMode="Single"
                        SelectedItem="{Binding SelectedCourse, Mode=TwoWay}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame CornerRadius="18" HasShadow="True" Padding="0" Margin="12,10,12,0" BackgroundColor="#FFF">
                                    <Grid Padding="10" RowDefinitions="Auto,Auto" ColumnDefinitions="80,*,Auto">
                                        <!-- Ảnh khoá học -->
                                        <Image Source="{Binding ImageUrl}" WidthRequest="60" HeightRequest="60" Aspect="AspectFill" Grid.RowSpan="2" VerticalOptions="Center"/>
                                        <!-- Thông tin chính -->
                                        <VerticalStackLayout Grid.Column="1" Padding="10,0,0,0">
                                            <Label Text="{Binding Title}" FontSize="17" FontAttributes="Bold" TextColor="#21264C"/>
                                            <Label Text="{Binding Description}" FontSize="12" LineBreakMode="TailTruncation" TextColor="#6A7691" />
                                        </VerticalStackLayout>
                                        <!-- Level, Số bài học, điểm yêu cầu -->
                                        <VerticalStackLayout Grid.Column="2" Padding="0" VerticalOptions="Center">
                                            <Label Text="{Binding Level}" FontSize="13" TextColor="#6376E0" FontAttributes="Bold"/>
                                            <Label Text="🧩 {Binding TotalLessons} bài" FontSize="12" TextColor="#3C4662"/>
                                            <Label Text="🔓 {Binding RequiredPointsToUnlock} điểm" FontSize="12" TextColor="#A1A5BC"/>
                                        </VerticalStackLayout>
                                    </Grid>
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CoursesViewModel}}, Path=CourseSelectedCommand}" CommandParameter="{Binding .}" />
                                    </Frame.GestureRecognizers>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <Label Text="Không tìm thấy khoá học nào phù hợp." FontSize="16" TextColor="#8B94A3" HorizontalOptions="Center" Margin="0,40,0,0"/>
                        </CollectionView.EmptyView>
                    </CollectionView>
                </VerticalStackLayout>
            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
