<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodel="clr-namespace:LanguageLearningApp.ViewModels.User"
    xmlns:models="clr-namespace:LanguageLearningApp.Models"
    x:Class="LanguageLearningApp.Views.User.LessonPage"
    x:Name="ThisPage"
    Title="Làm bài tập"
    BackgroundColor="#f6fafe">

    <VerticalStackLayout Padding="18,16" Spacing="20">
        <!-- Header: Question Progress -->
        <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
            <Label Text="Câu hỏi" FontSize="16" TextColor="#0ea5e9" FontAttributes="Bold"/>
            <Label Text="{Binding CurrentQuestionIndex, Converter={StaticResource IntPlusOneConverter}}"
                   FontAttributes="Bold" TextColor="#1e293b"/>
            <Label Text="/" />
            <Label Text="{Binding TotalQuestions}" FontAttributes="Bold" TextColor="#1e293b"/>
        </HorizontalStackLayout>

        <!-- Question Image -->
        <Image Source="{Binding CurrentQuestion.ImageUrl}" HeightRequest="120"
               Aspect="AspectFit" HorizontalOptions="Center"
               IsVisible="{Binding CurrentQuestion.ImageUrl, Converter={StaticResource StringNotNullOrEmptyConverter}}" />

        <!-- Question Content -->
        <Label Text="{Binding CurrentQuestion.Content}" FontSize="17"
               FontAttributes="Bold" TextColor="#1e293b" Margin="0,2" />

        <!-- Multiple Choice -->
        <CollectionView ItemsSource="{Binding CurrentQuestion.Options}"
            IsVisible="{Binding CurrentQuestion.Type, Converter={StaticResource EnumEqualConverter}, ConverterParameter=MultipleChoice}"
            SelectionMode="None" Margin="0,2">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame CornerRadius="14" Padding="10,7" Margin="0,6,0,0"
                           BackgroundColor="{Binding ., Converter={StaticResource AnswerStateToColorConverter}, ConverterParameter={x:Reference ThisPage}}"
                           HasShadow="False">
                        <Label Text="{Binding .}" FontSize="15" TextColor="#23272f"/>
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding BindingContext.AnswerCommand, Source={x:Reference ThisPage}}"
                                                  CommandParameter="{Binding .}"/>
                        </Frame.GestureRecognizers>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- True/False -->
        <Grid ColumnDefinitions="*,*" ColumnSpacing="16"
              IsVisible="{Binding CurrentQuestion.Type, Converter={StaticResource EnumEqualConverter}, ConverterParameter=TrueFalse}">
            <Button Text="Đúng" Grid.Column="0"
                    Command="{Binding AnswerCommand}" CommandParameter="True"
                    IsEnabled="{Binding HasAnswered, Converter={StaticResource InvertBoolConverter}}"
                    BackgroundColor="{Binding SelectedAnswer, Converter={StaticResource AnswerTrueFalseColorConverter}, ConverterParameter=True}"
                    TextColor="Black" FontSize="15" CornerRadius="10" Padding="16,7"/>
            <Button Text="Sai" Grid.Column="1"
                    Command="{Binding AnswerCommand}" CommandParameter="False"
                    IsEnabled="{Binding HasAnswered, Converter={StaticResource InvertBoolConverter}}"
                    BackgroundColor="{Binding SelectedAnswer, Converter={StaticResource AnswerTrueFalseColorConverter}, ConverterParameter=False}"
                    TextColor="Black" FontSize="15" CornerRadius="10" Padding="16,7"/>
        </Grid>

        <!-- Essay / Fill In (Tự luận hoặc điền chỗ trống) -->
        <VerticalStackLayout IsVisible="{Binding CurrentQuestion.Type, Converter={StaticResource EnumEqualConverter}, ConverterParameter=Essay}">
            <Editor Text="{Binding UserAnswer}" Placeholder="Nhập đáp án của bạn..."
                    FontSize="15" HeightRequest="60" BackgroundColor="#f5f7fa" Margin="0,4,0,8"/>
            <Button Text="Gửi đáp án" Command="{Binding SubmitAnswerCommand}"
                    IsEnabled="{Binding HasAnswered, Converter={StaticResource InvertBoolConverter}}"
                    Style="{StaticResource PrimaryButton}"/>
        </VerticalStackLayout>

        <!-- Feedback -->
        <StackLayout IsVisible="{Binding HasAnswered}">
            <Label Text="{Binding IsAnswerCorrect, Converter={StaticResource CorrectToFeedbackTextConverter}}"
                   FontSize="16" FontAttributes="Bold"
                   TextColor="{Binding IsAnswerCorrect, Converter={StaticResource CorrectToFeedbackColorConverter}}"
                   HorizontalOptions="Center"/>
            <Label Text="{Binding Explanation}" FontSize="13"
                   TextColor="#64748b" Margin="0,3,0,0"
                   IsVisible="{Binding Explanation, Converter={StaticResource StringNotNullOrEmptyConverter}}"/>
            <Button Text="{Binding CurrentQuestionIndex, Converter={StaticResource IsLastQuestionToNextOrFinishTextConverter}, ConverterParameter={Binding TotalQuestions}}"
                    Command="{Binding NextQuestionCommand}"
                    FontAttributes="Bold" BackgroundColor="#0ea5e9"
                    TextColor="Black" CornerRadius="10" Padding="18,8"
                    Margin="0,10,0,0"/>
        </StackLayout>

        <!-- Loading -->
        <ActivityIndicator IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}"
            Color="#2563eb" Margin="0,14"/>
    </VerticalStackLayout>
</ContentPage>
